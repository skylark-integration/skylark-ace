{"version":3,"sources":["worker/worker_client.js"],"names":["define","oop","net","m_event_emitter","config","EventEmitter","createWorker","workerUrl","Worker","postMessage","terminate","get","blob","script","qualifyURL","Blob","type","e","blobBuilder","window","BlobBuilder","WebKitBlobBuilder","MozBlobBuilder","append","getBlob","$workerBlob","blobURL","URL","webkitURL","createObjectURL","WorkerClient","worker","this","$createWorkerFromOldConfig","apply","arguments","$worker","$sendDeltaQueue","bind","changeListener","onMessage","callbackId","callbacks","onmessage","implement","topLevelNamespaces","mod","classname","importScripts","require","nameToUrl","toUrl","moduleUrl","normalizePath","$normalizePath","tlns","forEach","ns","replace","send","init","module","msg","data","_signal","name","callback","id","reportError","console","log","err","error","path","deltaQueue","$doc","off","cmd","args","command","call","push","emit","event","message","stack","code","ex","attachToDocument","doc","getValue","on","delta","setTimeout","action","start","lines","end","q","length","getLength","prototype","UIWorkerClient","main","emitSync","sender","Object","create","messageBuffer","workerClient","processNext","setEmitSync","val","shift","loadModule","Main"],"mappings":"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","file":"../../worker/worker_client.js","sourcesContent":["/* ***** BEGIN LICENSE BLOCK *****\r\n * Distributed under the BSD license:\r\n *\r\n * Copyright (c) 2010, Ajax.org B.V.\r\n * All rights reserved.\r\n *\r\n * Redistribution and use in source and binary forms, with or without\r\n * modification, are permitted provided that the following conditions are met:\r\n *     * Redistributions of source code must retain the above copyright\r\n *       notice, this list of conditions and the following disclaimer.\r\n *     * Redistributions in binary form must reproduce the above copyright\r\n *       notice, this list of conditions and the following disclaimer in the\r\n *       documentation and/or other materials provided with the distribution.\r\n *     * Neither the name of Ajax.org B.V. nor the\r\n *       names of its contributors may be used to endorse or promote products\r\n *       derived from this software without specific prior written permission.\r\n *\r\n * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\r\n * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\r\n * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\r\n * DISCLAIMED. IN NO EVENT SHALL AJAX.ORG B.V. BE LIABLE FOR ANY\r\n * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\r\n * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\r\n * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND\r\n * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\r\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\r\n * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\r\n *\r\n * ***** END LICENSE BLOCK ***** */\r\n\r\ndefine([\r\n    \"../lib/oop\",\r\n    \"../lib/net\",\r\n    \"../lib/event_emitter\",\r\n    \"../config\"\r\n],function(oop, net, m_event_emitter,config) {\r\n\"use strict\";\r\n\r\n    ///var oop = require(\"../lib/oop\");\r\n    ///var net = require(\"../lib/net\");\r\n    ///var EventEmitter = require(\"../lib/event_emitter\").EventEmitter;\r\n    ///var config = require(\"../config\");\r\n    var EventEmitter = m_event_emitter.EventEmitter;\r\n\r\n    function $workerBlob(workerUrl) {\r\n        // workerUrl can be protocol relative\r\n        // importScripts only takes fully qualified urls\r\n        var script = \"importScripts('\" + net.qualifyURL(workerUrl) + \"');\";\r\n        try {\r\n            return new Blob([script], {\"type\": \"application/javascript\"});\r\n        } catch (e) { // Backwards-compatibility\r\n            var BlobBuilder = window.BlobBuilder || window.WebKitBlobBuilder || window.MozBlobBuilder;\r\n            var blobBuilder = new BlobBuilder();\r\n            blobBuilder.append(script);\r\n            return blobBuilder.getBlob(\"application/javascript\");\r\n        }\r\n    }\r\n\r\n    function createWorker(workerUrl) {\r\n        if (typeof Worker == \"undefined\")\r\n            return { postMessage: function() {}, terminate: function() {} };\r\n        if (config.get(\"loadWorkerFromBlob\")) {\r\n            var blob = $workerBlob(workerUrl);\r\n            var URL = window.URL || window.webkitURL;\r\n            var blobURL = URL.createObjectURL(blob);\r\n            // calling URL.revokeObjectURL before worker is terminated breaks it on IE Edge\r\n            return new Worker(blobURL);\r\n        }\r\n        return new Worker(workerUrl);\r\n    }\r\n\r\n    var WorkerClient = function(worker) {\r\n        if (!worker.postMessage)\r\n            worker = this.$createWorkerFromOldConfig.apply(this, arguments);\r\n\r\n        this.$worker = worker;\r\n        this.$sendDeltaQueue = this.$sendDeltaQueue.bind(this);\r\n        this.changeListener = this.changeListener.bind(this);\r\n        this.onMessage = this.onMessage.bind(this);\r\n\r\n        this.callbackId = 1;\r\n        this.callbacks = {};\r\n\r\n        this.$worker.onmessage = this.onMessage;\r\n    };\r\n\r\n    (function(){\r\n\r\n        oop.implement(this, EventEmitter);\r\n\r\n        this.$createWorkerFromOldConfig = function(topLevelNamespaces, mod, classname, workerUrl, importScripts) {\r\n            // nameToUrl is renamed to toUrl in requirejs 2\r\n            if (require.nameToUrl && !require.toUrl)\r\n                require.toUrl = require.nameToUrl;\r\n\r\n            if (config.get(\"packaged\") || !require.toUrl) {\r\n                workerUrl = workerUrl || config.moduleUrl(mod, \"worker\");\r\n            } else {\r\n                var normalizePath = this.$normalizePath;\r\n                workerUrl = workerUrl || normalizePath(require.toUrl(\"ace/worker/worker.js\", null, \"_\"));\r\n\r\n                var tlns = {};\r\n                topLevelNamespaces.forEach(function(ns) {\r\n                    //tlns[ns] = normalizePath(require.toUrl(ns, null, \"_\").replace(/(\\.js)?(\\?.*)?$/, \"\")); // modified by lwf\r\n                    tlns[ns] = normalizePath(require.toUrl(ns+\"/\").replace(/(\\.js)?(\\?.*)?$/, \"\")); \r\n                });\r\n            }\r\n\r\n            this.$worker = createWorker(workerUrl);\r\n            if (importScripts) {\r\n                this.send(\"importScripts\", importScripts);\r\n            }\r\n            this.$worker.postMessage({\r\n                init : true,\r\n                tlns : tlns,\r\n                module : mod,\r\n                classname : classname\r\n            });\r\n            return this.$worker;\r\n        };\r\n\r\n        this.onMessage = function(e) {\r\n            var msg = e.data;\r\n            switch (msg.type) {\r\n                case \"event\":\r\n                    this._signal(msg.name, {data: msg.data});\r\n                    break;\r\n                case \"call\":\r\n                    var callback = this.callbacks[msg.id];\r\n                    if (callback) {\r\n                        callback(msg.data);\r\n                        delete this.callbacks[msg.id];\r\n                    }\r\n                    break;\r\n                case \"error\":\r\n                    this.reportError(msg.data);\r\n                    break;\r\n                case \"log\":\r\n                    window.console && console.log && console.log.apply(console, msg.data);\r\n                    break;\r\n            }\r\n        };\r\n        \r\n        this.reportError = function(err) {\r\n            window.console && console.error && console.error(err);\r\n        };\r\n\r\n        this.$normalizePath = function(path) {\r\n            return net.qualifyURL(path);\r\n        };\r\n\r\n        this.terminate = function() {\r\n            this._signal(\"terminate\", {});\r\n            this.deltaQueue = null;\r\n            this.$worker.terminate();\r\n            this.$worker = null;\r\n            if (this.$doc)\r\n                this.$doc.off(\"change\", this.changeListener);\r\n            this.$doc = null;\r\n        };\r\n\r\n        this.send = function(cmd, args) {\r\n            this.$worker.postMessage({command: cmd, args: args});\r\n        };\r\n\r\n        this.call = function(cmd, args, callback) {\r\n            if (callback) {\r\n                var id = this.callbackId++;\r\n                this.callbacks[id] = callback;\r\n                args.push(id);\r\n            }\r\n            this.send(cmd, args);\r\n        };\r\n\r\n        this.emit = function(event, data) {\r\n            try {\r\n                // firefox refuses to clone objects which have function properties\r\n                // TODO: cleanup event\r\n                if (data.data && data.data.err)\r\n                    data.data.err = {message: data.data.err.message, stack: data.data.err.stack, code: data.data.err.code};\r\n                this.$worker.postMessage({event: event, data: {data: data.data}});\r\n            }\r\n            catch(ex) {\r\n                console.error(ex.stack);\r\n            }\r\n        };\r\n\r\n        this.attachToDocument = function(doc) {\r\n            if (this.$doc)\r\n                this.terminate();\r\n\r\n            this.$doc = doc;\r\n            this.call(\"setValue\", [doc.getValue()]);\r\n            doc.on(\"change\", this.changeListener);\r\n        };\r\n\r\n        this.changeListener = function(delta) {\r\n            if (!this.deltaQueue) {\r\n                this.deltaQueue = [];\r\n                setTimeout(this.$sendDeltaQueue, 0);\r\n            }\r\n            if (delta.action == \"insert\")\r\n                this.deltaQueue.push(delta.start, delta.lines);\r\n            else\r\n                this.deltaQueue.push(delta.start, delta.end);\r\n        };\r\n\r\n        this.$sendDeltaQueue = function() {\r\n            var q = this.deltaQueue;\r\n            if (!q) return;\r\n            this.deltaQueue = null;\r\n            if (q.length > 50 && q.length > this.$doc.getLength() >> 1) {\r\n                this.call(\"setValue\", [this.$doc.getValue()]);\r\n            } else\r\n                this.emit(\"change\", {data: q});\r\n        };\r\n\r\n    }).call(WorkerClient.prototype);\r\n\r\n\r\n    var UIWorkerClient = function(topLevelNamespaces, mod, classname) {\r\n        var main = null;\r\n        var emitSync = false;\r\n        var sender = Object.create(EventEmitter);\r\n\r\n        var messageBuffer = [];\r\n        var workerClient = new WorkerClient({\r\n            messageBuffer: messageBuffer,\r\n            terminate: function() {},\r\n            postMessage: function(e) {\r\n                messageBuffer.push(e);\r\n                if (!main) return;\r\n                if (emitSync)\r\n                    setTimeout(processNext);\r\n                else\r\n                    processNext();\r\n            }\r\n        });\r\n\r\n        workerClient.setEmitSync = function(val) { emitSync = val; };\r\n\r\n        var processNext = function() {\r\n            var msg = messageBuffer.shift();\r\n            if (msg.command)\r\n                main[msg.command].apply(main, msg.args);\r\n            else if (msg.event)\r\n                sender._signal(msg.event, msg.data);\r\n        };\r\n\r\n        sender.postMessage = function(msg) {\r\n            workerClient.onMessage({data: msg});\r\n        };\r\n        sender.callback = function(data, callbackId) {\r\n            this.postMessage({type: \"call\", id: callbackId, data: data});\r\n        };\r\n        sender.emit = function(name, data) {\r\n            this.postMessage({type: \"event\", name: name, data: data});\r\n        };\r\n\r\n        config.loadModule([\"worker\", mod], function(Main) {\r\n            main = new Main[classname](sender);\r\n            while (messageBuffer.length)\r\n                processNext();\r\n        });\r\n\r\n        return workerClient;\r\n    };\r\n\r\n    return {\r\n        UIWorkerClient,\r\n        WorkerClient,\r\n        createWorker\r\n    };\r\n    ///exports.UIWorkerClient = UIWorkerClient;\r\n    ///exports.WorkerClient = WorkerClient;\r\n    ///exports.createWorker = createWorker;\r\n});\r\n"]}